<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="./favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="PLANNINGJOY株式会社 - 神戸・兵庫を拠点に、AIを活用した経営コンサルティング、補助金申請支援、事業承継支援、融資サポートを提供。創業から承継まで、中小企業の経営を支援します。" />
    <meta name="keywords" content="経営コンサルティング,AI,神戸,兵庫,補助金,融資,創業支援,事業承継,中小企業診断士" />
    <title>PLANNINGJOY株式会社 | 創業から承継まで経営の羅針盤</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- チャットボット共通スタイル -->
    <style id="dify-chat-styles">
      /* チャットウィンドウのスタイル */
      #shoukibo-jizoka-chatbot-window,
      #shorikika-chatbot-window {
        width: 380px !important;
        height: 600px !important;
        max-height: 80vh !important;
        max-width: calc(100vw - 40px) !important;
        position: fixed !important;
        bottom: 20px !important;
        right: 20px !important;
        z-index: 2147483647 !important;
        display: none !important; /* 初期状態は非表示 */
        flex-direction: column !important;
        overflow: hidden !important;
        border-radius: 10px !important;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2) !important;
        background-color: #fff !important;
      }
      
      /* ヘッダーのスタイル */
      .dify-chatbot-bubble-window-header,
      .dify-chatbot-window-header {
        background-color: #1C64F2 !important;
        padding: 0.75rem !important;
        color: white !important;
        font-weight: 600 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
        position: relative !important;
      }
      
      /* コンテンツ部分 */
      .dify-chatbot-bubble-window-content {
        flex: 1 !important;
        overflow: hidden !important;
        position: relative !important;
        height: calc(100% - 50px) !important;
      }
      
      /* iframe スタイル */
      .dify-chatbot-bubble-window-content iframe {
        width: 100% !important;
        height: 100% !important;
        border: none !important;
        display: block !important;
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
      }
      
      /* 閉じるボタン */
      .custom-close-button {
        position: absolute !important;
        top: 10px !important;
        right: 10px !important;
        background-color: rgba(255, 255, 255, 0.2) !important;
        color: white !important;
        border: none !important;
        border-radius: 50% !important;
        width: 30px !important;
        height: 30px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        cursor: pointer !important;
        font-size: 18px !important;
        z-index: 2147483647 !important;
      }
      
      .custom-close-button:hover {
        background-color: rgba(255, 255, 255, 0.3) !important;
      }
      
      /* モバイル対応 */
      @media (max-width: 640px) {
        #shoukibo-jizoka-chatbot-window,
        #shorikika-chatbot-window {
          width: calc(100vw - 32px) !important;
          height: 80vh !important;
          bottom: 1rem !important;
          right: 1rem !important;
          left: 1rem !important;
        }
      }
      
      /* Difyブランディングを非表示 */
      .dify-brand-container,
      [class*="brand-container"],
      [class*="brandContainer"] {
        display: none !important;
      }
      
      /* エラーメッセージを非表示 */
      .dify-error-message, 
      [class*="error-message"], 
      [class*="errorMessage"] {
        display: none !important;
      }
      
      /* iOS Safari 対応 */
      @supports (-webkit-touch-callout: none) {
        #shoukibo-jizoka-chatbot-window,
        #shorikika-chatbot-window {
          transform: translateZ(0) !important;
          -webkit-transform: translateZ(0) !important;
        }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    
    <!-- チャットボット設定 -->
    <script>
      // 設定
      const CHATBOT_CONFIG = {
        shoukibo: {
          token: 'jpVCvswMb5KaQFLk',
          elementId: 'shoukibo-jizoka-chatbot-window',
          title: '小規模持続化補助金AI相談'
        },
        shorikika: {
          token: 'kAwDqVSCnjM6ZfEY',
          elementId: 'shorikika-chatbot-window',
          title: '省力化投資補助金AI相談'
        },
        apiEndpoint: 'https://api.dify.ai/v1',
        cdnUrls: {
          primary: 'https://cdn.jsdelivr.net/npm/@dify-ai/chatbot@1.0.9/dist/index.min.js',
          fallback: 'https://unpkg.com/@dify-ai/chatbot@1.0.9/dist/index.min.js'
        },
        timeout: 10000
      };
      
      // グローバル変数
      window.chatbotInitialized = false;
      window.shoukiboJizokaChatbot = null;
      window.shorikika_chatbot = null;
      
      // DOMの読み込み完了時に実行
      document.addEventListener('DOMContentLoaded', initializeChatbots);
      
      // チャットボットの初期化
      function initializeChatbots() {
        if (window.chatbotInitialized) return;
        console.log('チャットボットの初期化を開始します');
        
        // スクリプトの読み込み
        loadDifyScript();
      }
      
      // Difyスクリプトを読み込む
      function loadDifyScript() {
        const script = document.createElement('script');
        script.id = 'dify-script';
        script.src = CHATBOT_CONFIG.cdnUrls.primary;
        script.async = true;
        script.crossOrigin = 'anonymous';
        
        // タイムアウト処理
        const timeoutId = setTimeout(() => {
          if (!window.DifyAI) {
            console.warn('プライマリCDNからのスクリプト読み込みがタイムアウトしました。フォールバックを試みます...');
            script.src = CHATBOT_CONFIG.cdnUrls.fallback;
          }
        }, CHATBOT_CONFIG.timeout);
        
        // スクリプト読み込み成功時
        script.onload = function() {
          clearTimeout(timeoutId);
          console.log('Difyスクリプトの読み込みに成功しました');
          
          // DOMが完全に読み込まれた後にセットアップを実行
          if (document.readyState === 'complete') {
            setupChatbots();
          } else {
            window.addEventListener('load', setupChatbots);
          }
        };
        
        // スクリプト読み込み失敗時
        script.onerror = function() {
          clearTimeout(timeoutId);
          console.error('Difyスクリプトの読み込みに失敗しました');
          
          // フォールバックCDNを試す
          const fallbackScript = document.createElement('script');
          fallbackScript.id = 'dify-fallback-script';
          fallbackScript.src = CHATBOT_CONFIG.cdnUrls.fallback;
          fallbackScript.async = true;
          fallbackScript.crossOrigin = 'anonymous';
          
          fallbackScript.onload = function() {
            console.log('フォールバックスクリプトの読み込みに成功しました');
            
            // DOMが完全に読み込まれた後にセットアップを実行
            if (document.readyState === 'complete') {
              setupChatbots();
            } else {
              window.addEventListener('load', setupChatbots);
            }
          };
          
          fallbackScript.onerror = function() {
            console.error('すべてのスクリプト読み込みに失敗しました');
          };
          
          document.head.appendChild(fallbackScript);
        };
        
        document.head.appendChild(script);
      }
      
      // チャットボットのセットアップ
      function setupChatbots() {
        if (!window.DifyAI) {
          console.error('DifyAI オブジェクトが見つかりません');
          return;
        }
        
        if (window.chatbotInitialized) {
          console.log('チャットボットはすでに初期化されています');
          return;
        }
        
        console.log('チャットボットのセットアップを開始します');
        
        try {
          // 小規模持続化補助金チャットボット
          const shoukiboConfig = CHATBOT_CONFIG.shoukibo;
          const shoukiboContainer = document.createElement('div');
          shoukiboContainer.id = shoukiboConfig.elementId;
          document.body.appendChild(shoukiboContainer);
          
          window.shoukiboJizokaChatbot = DifyAI.createChatbot({
            apiEndpoint: CHATBOT_CONFIG.apiEndpoint,
            accessToken: shoukiboConfig.token,
            container: `#${shoukiboConfig.elementId}`,
            containerAttributes: {
              style: {
                width: '100%',
                height: '100%'
              }
            }
          });
          
          // 省力化投資補助金チャットボット
          const shorikikaConfig = CHATBOT_CONFIG.shorikika;
          const shorikikaContainer = document.createElement('div');
          shorikikaContainer.id = shorikikaConfig.elementId;
          document.body.appendChild(shorikikaContainer);
          
          window.shorikika_chatbot = DifyAI.createChatbot({
            apiEndpoint: CHATBOT_CONFIG.apiEndpoint,
            accessToken: shorikikaConfig.token,
            container: `#${shorikikaConfig.elementId}`,
            containerAttributes: {
              style: {
                width: '100%',
                height: '100%'
              }
            }
          });
          
          // グローバル関数を設定
          setupGlobalFunctions();
          
          // カスタム閉じるボタンを追加
          setTimeout(addCustomCloseButtons, 1000);
          
          window.chatbotInitialized = true;
          console.log('チャットボットの初期化が完了しました');
        } catch (error) {
          console.error('チャットボットの初期化中にエラーが発生しました:', error);
        }
      }
      
      // グローバル関数のセットアップ
      function setupGlobalFunctions() {
        // 小規模持続化補助金チャットを開く
        window.openShoukiboJizokaChat = function() {
          closeAllChatWindows();
          if (window.shoukiboJizokaChatbot) {
            if (typeof window.shoukiboJizokaChatbot.open === 'function') {
              window.shoukiboJizokaChatbot.open();
            } else if (typeof window.shoukiboJizokaChatbot.toggle === 'function') {
              window.shoukiboJizokaChatbot.toggle();
            }
            openChatWindow('shoukibo-jizoka-chatbot-window', CHATBOT_CONFIG.shoukibo.title);
          } else {
            console.error('小規模持続化補助金チャットボットが初期化されていません');
          }
        };
        
        // 省力化投資補助金チャットを開く
        window.openShorikikaChat = function() {
          closeAllChatWindows();
          if (window.shorikika_chatbot) {
            if (typeof window.shorikika_chatbot.open === 'function') {
              window.shorikika_chatbot.open();
            } else if (typeof window.shorikika_chatbot.toggle === 'function') {
              window.shorikika_chatbot.toggle();
            }
            openChatWindow('shorikika-chatbot-window', CHATBOT_CONFIG.shorikika.title);
          } else {
            console.error('省力化投資補助金チャットボットが初期化されていません');
          }
        };
        
        // 後方互換性のための関数
        window.startShoukiboJizokaChat = window.openShoukiboJizokaChat;
        window.startShorikikaChat = window.openShorikikaChat;
        window.openSmallBusinessChatbot = window.openShoukiboJizokaChat;
        window.openSubsidyChatbot = window.openShorikikaChat;
      }
      
      // チャットウィンドウを開く
      function openChatWindow(id, title) {
        console.log(`チャットウィンドウを開きます: ${id}`);
        
        const chatWindow = document.getElementById(id);
        if (!chatWindow) {
          console.error(`チャットウィンドウが見つかりません: ${id}`);
          return;
        }
        
        // チャットウィンドウを表示
        chatWindow.style.display = 'flex';
        
        // タイトルを設定（ヘッダー要素がある場合）
        const headerElement = chatWindow.querySelector('.dify-chatbot-bubble-window-header, .dify-chatbot-window-header');
        if (headerElement && title) {
          headerElement.textContent = title;
        }
        
        // カスタム閉じるボタンを追加（まだなければ）
        addCustomCloseButton(id, title);
      }
      
      // すべてのチャットウィンドウを閉じる
      function closeAllChatWindows() {
        const chatWindows = [
          'shoukibo-jizoka-chatbot-window',
          'shorikika-chatbot-window'
        ];
        
        chatWindows.forEach(id => {
          const window = document.getElementById(id);
          if (window) {
            window.style.display = 'none';
          }
        });
      }
      
      // チャットウィンドウを閉じる
      function hideChat(id) {
        const chatWindow = document.getElementById(id);
        if (chatWindow) {
          chatWindow.style.display = 'none';
        }
      }
      
      // カスタム閉じるボタンを追加
      function addCustomCloseButtons() {
        const chatWindows = [
          {
            id: 'shoukibo-jizoka-chatbot-window',
            title: CHATBOT_CONFIG.shoukibo.title
          },
          {
            id: 'shorikika-chatbot-window',
            title: CHATBOT_CONFIG.shorikika.title
          }
        ];
        
        chatWindows.forEach(chat => {
          addCustomCloseButton(chat.id, chat.title);
        });
      }
      
      // 単一のチャットウィンドウに閉じるボタンを追加
      function addCustomCloseButton(id, title) {
        const chatWindow = document.getElementById(id);
        if (!chatWindow) return;
        
        // ヘッダー要素を取得
        const headerElement = chatWindow.querySelector('.dify-chatbot-bubble-window-header, .dify-chatbot-window-header');
        if (!headerElement) return;
        
        // 既存の閉じるボタンを確認
        if (headerElement.querySelector('.custom-close-button')) return;
        
        // タイトルを設定
        if (title) {
          headerElement.textContent = title;
        }
        
        // カスタム閉じるボタンを作成
        const closeButton = document.createElement('button');
        closeButton.innerHTML = '×';
        closeButton.className = 'custom-close-button';
        closeButton.onclick = () => hideChat(id);
        
        // ヘッダーに閉じるボタンを追加
        headerElement.appendChild(closeButton);
      }
    </script>
    
    <!-- Lovable script -->
    <script src="https://cdn.gpteng.co/gptengineer.js" type="module"></script>
    
    <script type="module" src="./src/main.tsx"></script>
  </body>
</html>
